<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Public Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="w-full max-w-2xl p-4 bg-white shadow rounded">
      <h2 class="text-2xl font-bold mb-4">Public Chat</h2>

      <!-- Name Input -->
      <div id="nameInputArea" class="space-x-2 mb-4">
        <input
          type="text"
          id="nameInput"
          class="border rounded px-3 py-2 w-2/3"
          placeholder="Enter your name"
        />
        <button
          onclick="setName()"
          class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded"
        >
          Join Chat
        </button>
      </div>

      <!-- Chat Area -->
      <div id="chatArea" class="hidden flex flex-col gap-2">
        <div
          id="chat"
          class="h-96 overflow-y-auto border rounded p-4 bg-gray-50 flex flex-col gap-2"
        ></div>
        <div class="flex mt-2">
          <input
            type="text"
            id="messageInput"
            class="border rounded px-3 py-2 flex-1 mr-2"
            placeholder="Type message..."
          />
          <button
            onclick="sendMessage()"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded"
          >
            Send
          </button>
        </div>
      </div>
    </div>

    <script>
      let socket;
      let name;
      let colorMap = {};
      let userColor;

      function getRandomColor() {
        const colors = [
          "text-red-500",
          "text-blue-500",
          "text-green-500",
          "text-purple-500",
          "text-yellow-500",
          "text-pink-500",
          "text-indigo-500",
          "text-orange-500",
        ];
        return colors[Math.floor(Math.random() * colors.length)];
      }

      function setName() {
        name = document.getElementById("nameInput").value.trim();
        if (!name) return alert("Please enter a name");

        userColor = getRandomColor(); // Save local user color

        socket = new WebSocket(`ws://${location.hostname}:3000`);

        socket.onopen = () => {
          socket.send(JSON.stringify({ type: "setName", name }));
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          const chat = document.getElementById("chat");

          const msgDiv = document.createElement("div");

          if (data.type === "chat") {
            const [sender, ...messageParts] = data.message.split(": ");
            const message = messageParts.join(": ");

            // Assign color if new user
            if (!colorMap[sender]) {
              colorMap[sender] = sender === name ? userColor : getRandomColor();
            }

            const colorClass = colorMap[sender];

            const isSelf = sender === name;

            msgDiv.className = `flex ${
              isSelf ? "justify-end" : "justify-start"
            }`;

            msgDiv.innerHTML = `
              <div class="max-w-xs px-4 py-2 rounded-lg shadow ${
                isSelf ? "bg-blue-100 text-right" : "bg-gray-200 text-left"
              }">
                <div class="text-sm font-semibold ${colorClass}">${sender}</div>
                <div class="text-gray-800">${message}</div>
              </div>
            `;
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
          }

          if (data.type === "info") {
            const infoMsg = document.createElement("div");
            infoMsg.className = "text-center text-sm text-gray-500";
            infoMsg.textContent = data.message;
            chat.appendChild(infoMsg);
            chat.scrollTop = chat.scrollHeight;
          }
        };

        document.getElementById("nameInputArea").classList.add("hidden");
        document.getElementById("chatArea").classList.remove("hidden");
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (message) {
          socket.send(JSON.stringify({ type: "chat", message }));
          input.value = "";
        }
      }
    </script>
  </body>
</html>
